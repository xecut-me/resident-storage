# Resident Store

Project was generated by Claude Code Opus 4.5 using prompt below. Code was human reviewed for sanity and security to prevent logic errors and language misuse.

## Design

Write fastapi dockerized account storage microservice with role separation, HTTPBearer, pydantic validation and cryptographic chaining to last version, store in /data as unixtime-sha256.json.

API keys are passed via env and should be at least 10 chars, crash if they are not present, secure or unique.

Updating should take global lock. If no last version exist, stub should be returned and used as base: unixtime: 0, sha256: all 0, accounts = [].

## Run

```
# Build and run
docker build -t resident-store .
docker run -p 8000:8000 \
  -e READ_KEY=your_read_key_here \
  -e WRITE_KEY=your_write_key_here \
  -e DECENTRALA_ELECTION_KEY=your_election_key \
  -v /path/to/data:/data \
  resident-store
```

## Endpoints:

GET / - redirect to Swagger UI's /docs
GET /accounts - return last JSON file contents, do not re-serialize so hashes will match.
POST /accounts - validate, serialize and save new version into file, return {ok: true}.
GET /dump - return a dict with all versions, key = filename, value = string of file content.

### Decentrala key

When reading, use stub meta and filter decentrala=true only.

When writing, take last file as base and use just payload's resident field of decentrala=true.

## Format:

{
    "meta": {
        "unixtime",
        "last_sha256"
    },
    "accounts": [
        {
            "username": unique required str,
            "telegram": unique optional str,
            "decentrala": bool,
            "resident": bool,
            "otp_prefix": unique optional str,
            "vpn": [
                {
                    "ip": unique 192.168.11.x where 2 <= x <= 250,
                    "wg_public_key": unique ^[A-Za-z0-9+/]{43}=?$
                }
            ]
        }
    ]
}

Use same model for input validation and for output generation.

## Keys:

READ_KEY - can GET /accounts and GET /dump
WRITE_KEY - what READ_KEY can, plus POST /accounts
DECENTRALA_ELECTION_KEY - can filtered GET /accounts and POST /accounts update residency of decentrala accounts

## Use versions:

python:3.13-slim

fastapi==0.128.0
uvicorn[standard]==0.40.0
pydantic==2.12.5

# Ideas for future (not implement without design done)

- Track resident fees paid
- HTML page for easier json edit + maybe some-GUI-ish helper
